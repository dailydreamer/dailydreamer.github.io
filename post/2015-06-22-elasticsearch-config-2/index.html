<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="dailydreamer的小空间">


<link rel="shortcut icon" href="/images/avatar.jpg" />

<meta name="keywords" content="ElasticSearch, 搜索">
<title>ElasticSearch搜索配置（2）</title>

<link href="/index.xml" rel="alternate" type="application/rss+xml" title="dailydreamer" />
<link href="/index.xml" rel="feed" type="application/rss+xml" title="dailydreamer" />

<link href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.5.0/css/bulma.min.css" rel="stylesheet" type="text/css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
<link href="/css/style.css" rel="stylesheet" type="text/css">

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML">
</script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-75912368-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body>
  <nav class="nav has-shadow">
  <div class="nav-left">
    <span id="toggle__menu" class="nav-toggle">
      <span></span>
      <span></span>
      <span></span>
    </span>
    <a href="/index.html" class="nav-item">Dailydreamer's Space</a>
  </div>

  <div class="nav-center">
    <a class="nav-item" href="https://github.com/dailydreamer">
      <span class="icon">
        <i class="fa fa-github"></i>
      </span>
    </a>
    <a class="nav-item" href="https://www.linkedin.com/in/dailydreamer/">
      <span class="icon">
        <i class="fa fa-linkedin-square" aria-hidden="true"></i>        
      </span>
    </a>
    <a class="nav-item" href="/index.xml" type="application/rss+xml">
      <span class="icon">
        <i class="fa fa-rss"></i>
      </span>
    </a>
  </div>
</nav>      

  <div id="container">
    <aside>
  <nav class="sidebar">
    <div id="tags__ul">
      <a id="all_posts" class="tag is-rounded is-primary">
        全部 
        <span class="tag-count">31</span>
      </a>
      
      <a id="编程" class="tag is-rounded">
        编程 
        <span class="tag-count">16</span>
      </a>
      
      <a id="读书笔记" class="tag is-rounded">
        读书笔记 
        <span class="tag-count">13</span>
      </a>
      
      <a id="项目" class="tag is-rounded">
        项目 
        <span class="tag-count">6</span>
      </a>
      
      <a id="web" class="tag is-rounded">
        web 
        <span class="tag-count">5</span>
      </a>
      
      <a id="产品经理" class="tag is-rounded">
        产品经理 
        <span class="tag-count">5</span>
      </a>
      
      <a id="哲学" class="tag is-rounded">
        哲学 
        <span class="tag-count">3</span>
      </a>
      
      <a id="科学" class="tag is-rounded">
        科学 
        <span class="tag-count">3</span>
      </a>
      
      <a id="编程语言" class="tag is-rounded">
        编程语言 
        <span class="tag-count">3</span>
      </a>
      
      <a id="心理学" class="tag is-rounded">
        心理学 
        <span class="tag-count">2</span>
      </a>
      
      <a id="maker" class="tag is-rounded">
        maker 
        <span class="tag-count">1</span>
      </a>
      
      <a id="ssh" class="tag is-rounded">
        ssh 
        <span class="tag-count">1</span>
      </a>
      
      <a id="创业" class="tag is-rounded">
        创业 
        <span class="tag-count">1</span>
      </a>
      
      <a id="理财" class="tag is-rounded">
        理财 
        <span class="tag-count">1</span>
      </a>
      
      <a id="系统安全" class="tag is-rounded">
        系统安全 
        <span class="tag-count">1</span>
      </a>
      
      <a id="自动驾驶" class="tag is-rounded">
        自动驾驶 
        <span class="tag-count">1</span>
      </a>
      
      <a id="行业" class="tag is-rounded">
        行业 
        <span class="tag-count">1</span>
      </a>
      
      <a id="设计" class="tag is-rounded">
        设计 
        <span class="tag-count">1</span>
      </a>
      
    </div>

    <div class="menu">
      <ul id="posts__ul" class="menu-list">
        
        
        <li class="all_posts 项目 产品经理 行业">
          <a href="https://dailydreamer.me/post/2018-06-13-apparel-sales-prediction/">
            <span class="posts-title">智慧服装</span>
            <span class="posts-date">Jun, 2018</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 项目 maker">
          <a href="https://dailydreamer.me/post/2018-06-03-xlchain/">
            <span class="posts-title">XLChain</span>
            <span class="posts-date">Jun, 2018</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 项目 编程 自动驾驶">
          <a href="https://dailydreamer.me/post/2018-01-28-foodgo-autonomous-food-delivery/">
            <span class="posts-title">FoodGo, 层级式的配送小车</span>
            <span class="posts-date">Jan, 2018</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 产品经理 项目 创业">
          <a href="https://dailydreamer.me/post/2018-01-09-past-failed-experiences/">
            <span class="posts-title">过去失败的创业尝试</span>
            <span class="posts-date">Jan, 2018</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 项目 产品经理">
          <a href="https://dailydreamer.me/post/2017-12-05-nutriment/">
            <span class="posts-title">Nutriment</span>
            <span class="posts-date">Dec, 2017</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 科学 哲学">
          <a href="https://dailydreamer.me/post/2017-08-26-the-grand-design/">
            <span class="posts-title">大设计</span>
            <span class="posts-date">Aug, 2017</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 科学">
          <a href="https://dailydreamer.me/post/2017-08-07-a-new-kind-of-science-2/">
            <span class="posts-title">一种新科学(2)</span>
            <span class="posts-date">Aug, 2017</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 项目 心理学">
          <a href="https://dailydreamer.me/post/2017-05-21-gamification/">
            <span class="posts-title">游戏化 Gamification</span>
            <span class="posts-date">May, 2017</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 产品经理">
          <a href="https://dailydreamer.me/post/2016-06-16-mobile-application-experience/">
            <span class="posts-title">移动端体验</span>
            <span class="posts-date">Jun, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 理财">
          <a href="https://dailydreamer.me/post/2016-06-15-fund-tips/">
            <span class="posts-title">买基金给我加薪</span>
            <span class="posts-date">Jun, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 编程语言">
          <a href="https://dailydreamer.me/post/2016-06-09-inspired-by-functional-programing-language/">
            <span class="posts-title">从函数式语言想到的</span>
            <span class="posts-date">Jun, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 web">
          <a href="https://dailydreamer.me/post/2016-05-25-webrtc-introduction/">
            <span class="posts-title">WebRTC简介</span>
            <span class="posts-date">May, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 设计">
          <a href="https://dailydreamer.me/post/2016-05-24-some-design-books/">
            <span class="posts-title">读过的一些设计书籍</span>
            <span class="posts-date">May, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 web">
          <a href="https://dailydreamer.me/post/2016-04-25-dom-and-dom-event/">
            <span class="posts-title">DOM和DOM Event</span>
            <span class="posts-date">Apr, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 web">
          <a href="https://dailydreamer.me/post/2016-04-14-css-cheat-sheet/">
            <span class="posts-title">CSS Cheat Sheet</span>
            <span class="posts-date">Apr, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 web">
          <a href="https://dailydreamer.me/post/2016-04-09-spa-jwt-auth/">
            <span class="posts-title">单页应用JWT身份认证</span>
            <span class="posts-date">Apr, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 web">
          <a href="https://dailydreamer.me/post/2016-04-08-cors-solve-same-origin-policy-problem/">
            <span class="posts-title">CORS解决单页应用跨域问题</span>
            <span class="posts-date">Apr, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 科学">
          <a href="https://dailydreamer.me/post/2016-03-20-a-new-kind-of-science/">
            <span class="posts-title">一种新科学</span>
            <span class="posts-date">Mar, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 心理学">
          <a href="https://dailydreamer.me/post/2016-03-07-difficult-conversation/">
            <span class="posts-title">关键对话</span>
            <span class="posts-date">Mar, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 哲学">
          <a href="https://dailydreamer.me/post/2016-01-13-power-of-myth/">
            <span class="posts-title">神话的力量</span>
            <span class="posts-date">Jan, 2016</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 系统安全">
          <a href="https://dailydreamer.me/post/2015-11-23-meet-ctf/">
            <span class="posts-title">一次与CTF的邂逅</span>
            <span class="posts-date">Nov, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 ssh">
          <a href="https://dailydreamer.me/post/2015-10-30-ssh-config/">
            <span class="posts-title">多个github账号的ssh key切换</span>
            <span class="posts-date">Oct, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 哲学">
          <a href="https://dailydreamer.me/post/2015-08-04-zen-and-the-art-of-motorcycle-maintenance/">
            <span class="posts-title">禅与摩托车维修的艺术</span>
            <span class="posts-date">Aug, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 产品经理">
          <a href="https://dailydreamer.me/post/2015-07-25-product-manager/">
            <span class="posts-title">人人都是产品经理</span>
            <span class="posts-date">Jul, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 编程语言">
          <a href="https://dailydreamer.me/post/2015-06-29-hiding-mouse-globally-in-wpf/">
            <span class="posts-title">WPF全局隐藏鼠标</span>
            <span class="posts-date">Jun, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 编程">
          <a href="https://dailydreamer.me/post/2015-06-28-unix-programming-art/">
            <span class="posts-title">UNIX编程艺术</span>
            <span class="posts-date">Jun, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程 编程语言">
          <a href="https://dailydreamer.me/post/2015-06-23-python-yeild-and-parse-xml/">
            <span class="posts-title">Python解析XML与生成迭代器</span>
            <span class="posts-date">Jun, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程">
          <a href="https://dailydreamer.me/post/2015-06-22-elasticsearch-config-2/">
            <span class="posts-title">ElasticSearch搜索配置（2）</span>
            <span class="posts-date">Jun, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程">
          <a href="https://dailydreamer.me/post/2015-06-05-elasticsearch-config-1/">
            <span class="posts-title">ElasticSearch搜索配置（1）</span>
            <span class="posts-date">Jun, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 读书笔记 编程">
          <a href="https://dailydreamer.me/post/2015-06-04-a-pragmatic-programmer/">
            <span class="posts-title">程序员修炼之道</span>
            <span class="posts-date">Jun, 2015</span>
          </a>
        </li>
        
        
        
        <li class="all_posts 编程">
          <a href="https://dailydreamer.me/post/2015-06-02-config-elasticsearch-on-aws/">
            <span class="posts-title">在AWS上配置ElasticSearch</span>
            <span class="posts-date">Jun, 2015</span>
          </a>
        </li>
        
        
        
        
      </ul>
    </div>
  </nav>
</aside>
    <article>
      <div class="content post">
        <h1 data-identifier="2015-06-22">
          ElasticSearch搜索配置（2）
          <span class="posts-date">Jun, 2015</span> 
        </h1>       
        <div class="tags">
          
          <span class="tag is-medium" style="margin-left:0">编程</span>
          
        </div>
        

<p>这次再来说说ElasticSearch的其他一些特性。</p>

<h2 id="bulk">Bulk</h2>

<p>使用Index进行索引是一次索引一条doc，而bulk提供了批量索引的功能，能够显著的减少索引时间。
经过实际测试，对于1个100Mb约20K条doc，向远程服务器单节点发起索引的完成时间对比如下表。</p>

<table>
<thead>
<tr>
<th align="center">chunck_size</th>
<th align="center">time/s</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">200</td>
<td align="center">298.34</td>
</tr>

<tr>
<td align="center">500</td>
<td align="center">216.84</td>
</tr>

<tr>
<td align="center">1000</td>
<td align="center">169.64</td>
</tr>

<tr>
<td align="center">2000</td>
<td align="center">164.71</td>
</tr>
</tbody>
</table>

<p>可以看出chunck_size在一个合适的区间时可以显著减少索引时间，而chunck_size的选取也和一个doc的大小有关。</p>

<p>这里是<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html">官方文档</a>。</p>

<p>ElasticSearch的python API中对bulk进行了封装，有<code>helpers.streaming_bulk</code>和<code>helpers.bulk</code>两个方法，<a href="https://elasticsearch-py.readthedocs.org/en/master/helpers.html?highlight=bulk#elasticsearch.helpers.bulk">官方文档</a>在这。大致使用方法如下：</p>

<pre><code class="language-py">for success, fail in helpers.streaming_bulk(es, genDoc(filename), index=INDEX, doc_type=DOCTYPE, chunk_size=1000):
    print 'success: ', success
</code></pre>

<pre><code class="language-py">success, fail = helpers.bulk(es, genDoc(filename), index=INDEX, doc_type=DOCTYPE, chunk_size=1000)
</code></pre>

<p>其中geDoc()是一个迭代器。
这两个方法的区别在于bulk调用了streaming_bulk并将信息一起返回。</p>

<h2 id="拼音搜索">拼音搜索</h2>

<p>对于中文内容较多的索引，如果能够使用拼音搜索会十分方便。
ElasticSearch有插件<a href="https://github.com/medcl/elasticsearch-analysis-pinyin">elasticsearch-analysis-pinyin</a>可以实现这个功能。
它可以将中文转化为拼音字母，在建立索引的时候就可以在倒排列表中使对应的拼音字母关联到包含中文的Doc上。</p>

<p>为了将拼音搜索的索引和IK分词的索引结合，需要用到另一个插件<a href="https://github.com/yakaz/elasticsearch-analysis-combo/">elasticsearch-analysis-combo</a>。
它可以将两个Analyzer的结果合并起来得到一个新的Analyzer。</p>

<p>基本的配置如下。</p>

<pre><code class="language-yml">index:
  analysis:
    analyzer:
      ik:
          alias: [news_analyzer_ik,ik_analyzer]
          type: org.elasticsearch.index.analysis.IkAnalyzerProvider
      ik_max_word:
          type: ik
          use_smart: false
      ik_smart:
          type: ik
          use_smart: true
      pinyin:
        type: custom
        tokenizer: standard
        filter:
         - standard 
         - pinyin_filter
         - lowercase         
      combo:
        type: combo
        sub_analyzers: 
         - ik
         - pinyin
    filter:
      pinyin_filter : 
        type : pinyin
        first_letter : none
        padding_char : ''
</code></pre>

<p>先使用pinyin插件定义一个pinyin filter， <code>first_letter</code>属性看是否得到拼音首字母缩写，<code>padding_char</code>属性确定首字母缩写和全拼音的连接方式。
然后定义一个custom的pinyin analyzer。tokenizer使用standard，将所有汉字词语分成单个字，filter先通过standard初步过滤，然后使用pinyin filter转成单个字的拼音，最后使用lowercase统一小写。</p>

<p>效果如下：</p>

<p>输入命令</p>

<pre><code class="language-sh">curl -XGET 'http://localhost:9200/school_search_index/_analyze?analyzer=pinyin&amp;pretty' -d '清华大学'
</code></pre>

<p>得到结果</p>

<pre><code class="language-json">{
  &quot;tokens&quot; : [ {
    &quot;token&quot; : &quot;qing&quot;,
    &quot;start_offset&quot; : 0,
    &quot;end_offset&quot; : 1,
    &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
    &quot;position&quot; : 1
  }, {
    &quot;token&quot; : &quot;hua&quot;,
    &quot;start_offset&quot; : 1,
    &quot;end_offset&quot; : 2,
    &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
    &quot;position&quot; : 2
  }, {
    &quot;token&quot; : &quot;da&quot;,
    &quot;start_offset&quot; : 2,
    &quot;end_offset&quot; : 3,
    &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
    &quot;position&quot; : 3
  }, {
    &quot;token&quot; : &quot;xue&quot;,
    &quot;start_offset&quot; : 3,
    &quot;end_offset&quot; : 4,
    &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,
    &quot;position&quot; : 4
  } ]
}
</code></pre>

<p>最后使用combo analyzer将两个analyzer合并。</p>

<h2 id="自动补全">自动补全</h2>

<p>搜索引擎的自动补全有两种类型。
一种是基于你过去或者是其他人的热门的搜索历史进行补全，另一种是基于语言模型进行补全。</p>

<p>对于第一种根据搜索历史的补全，适用与拥有大量数据的搜索引擎。
在ElasticSearch中可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html">Completion Suggester</a>实现。
由于不适用与用户数据较少的搜索引擎，便不细说，可以参考<a href="http://blog.qbox.io/quick-and-dirty-autocomplete-with-elasticsearch-completion-suggest">这篇文章</a>。</p>

<p>第二种基于语言模型的补全，可以使用类似于拼音搜索的实现方式，在建立索引的时候对一个单词string的所有substring都建立到包含该string的Doc的映射即可。
但是需要注意的是这样会显著增加索引的大小。</p>

<p>在ElasticSearch中可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-ngram-tokenizer.html#analysis-ngram-tokenizer">n-Gram Tokenizer</a>或<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-ngram-tokenfilter.html">n-Gram filter</a>实现。
具体可以参考<a href="http://jontai.me/blog/2013/02/adding-autocomplete-to-an-elasticsearch-search-application/">这篇文章</a>。</p>

        
        <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dailydreamer" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>      
    </article>
  </div>

  <script src="/js/zepto.min.js"></script>
<script src="/js/script.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/languages/yaml.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>  
</body>
</html>
